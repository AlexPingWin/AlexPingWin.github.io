<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–£—á—ë—Ç —Ä–∞–±–æ—á–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –∫–æ–º–∞–Ω–¥—ã</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            border-radius: 15px;
            margin-bottom: 2rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        h1 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .subtitle {
            opacity: 0.9;
            font-size: 1.1rem;
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .block {
            background: white;
            padding: 2rem;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
        }

        .block-title {
            font-size: 1.5rem;
            margin-bottom: 1.5rem;
            color: #667eea;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #555;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        textarea {
            resize: vertical;
            min-height: 80px;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 14px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            width: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-danger {
            background: #ef4444;
        }

        .btn-success {
            background: #10b981;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 0.9rem;
            width: auto;
        }

        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        th {
            background: #667eea;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid #e5e7eb;
        }

        tr:hover {
            background: #f9fafb;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .badge-office { background: #dbeafe; color: #1e40af; }
        .badge-remote { background: #dcfce7; color: #166534; }
        .badge-hybrid { background: #fef3c7; color: #92400e; }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 12px;
            text-align: center;
        }

        .stat-card.warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }

        .stat-card.danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }

        .stat-card.success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: 0.3rem;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .filters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
            padding: 1rem;
            background: #f9fafb;
            border-radius: 8px;
        }

        .chart-container {
            margin-top: 1.5rem;
            position: relative;
            height: 300px;
        }

        .action-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
            flex-wrap: wrap;
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #999;
        }

        .delete-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
        }

        .delete-btn:hover {
            background: #dc2626;
        }

        .success-message {
            background: #d1fae5;
            color: #065f46;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: none;
        }

        .success-message.show {
            display: block;
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .category-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-top: 1rem;
        }

        .category-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .category-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }

        .period-status {
            display: inline-block;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            margin-left: 1rem;
        }

        .period-status.open {
            background: #d1fae5;
            color: #065f46;
        }

        .period-status.closed {
            background: #fee2e2;
            color: #991b1b;
        }

        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: 1fr 1fr;
            }

            h1 {
                font-size: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üìä –£—á—ë—Ç —Ä–∞–±–æ—á–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –∫–æ–º–∞–Ω–¥—ã</h1>
            <p class="subtitle">–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è —Å–∏—Å—Ç–µ–º–∞ —Ç–∞–±–µ–ª–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏</p>
        </header>

        <!-- –ë–ª–æ–∫ 1: –í–≤–æ–¥ –¥–∞–Ω–Ω—ã—Ö -->
        <div class="grid">
            <div class="block">
                <h2 class="block-title">‚ûï –î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å</h2>
                <div class="success-message" id="success-message"></div>

                <form id="entry-form">
                    <div class="form-group">
                        <label>–°–æ—Ç—Ä—É–¥–Ω–∏–∫ *</label>
                        <select id="employee" required>
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>–î–∞—Ç–∞ *</label>
                        <input type="date" id="date" required>
                    </div>

                    <div class="form-group">
                        <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —á–∞—Å–æ–≤ * (max 24)</label>
                        <input type="number" id="hours" min="0.5" max="24" step="0.5" required>
                    </div>

                    <div class="form-group">
                        <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è –≤—Ä–µ–º–µ–Ω–∏ *</label>
                        <select id="category" required>
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>–¢–∏–ø –¥–Ω—è *</label>
                        <select id="work-type" required>
                            <option value="office">üè¢ –û—Ñ–∏—Å</option>
                            <option value="remote">üè† –£–¥–∞–ª—ë–Ω–∫–∞</option>
                            <option value="hybrid">üîÄ –ì–∏–±—Ä–∏–¥</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
                        <textarea id="comment" placeholder="–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..."></textarea>
                    </div>

                    <button type="submit" class="btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∑–∞–ø–∏—Å—å</button>
                </form>
            </div>

            <!-- –ë–ª–æ–∫ 3: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ä–∞—Å—á—ë—Ç—ã -->
            <div class="block">
                <h2 class="block-title">üìà –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ä–∞—Å—á—ë—Ç—ã</h2>
                
                <div class="form-group">
                    <label>–°–æ—Ç—Ä—É–¥–Ω–∏–∫ –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞</label>
                    <select id="calc-employee" onchange="updateCalculations()">
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>–ü–µ—Ä–∏–æ–¥</label>
                    <input type="month" id="calc-period" onchange="updateCalculations()">
                </div>

                <div class="stats-grid" id="calculations-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="norm-hours">168</div>
                        <div class="stat-label">–ù–æ—Ä–º–∞ —á–∞—Å–æ–≤</div>
                    </div>
                    <div class="stat-card success">
                        <div class="stat-value" id="fact-hours">0</div>
                        <div class="stat-label">–§–∞–∫—Ç —á–∞—Å–æ–≤</div>
                    </div>
                    <div class="stat-card" id="deviation-card">
                        <div class="stat-value" id="deviation">0</div>
                        <div class="stat-label">–û—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ</div>
                    </div>
                    <div class="stat-card warning" id="overtime-card">
                        <div class="stat-value" id="overtime">0</div>
                        <div class="stat-label">–ü–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∞</div>
                    </div>
                </div>

                <div class="chart-container">
                    <canvas id="categories-chart"></canvas>
                </div>

                <div class="action-buttons">
                    <button class="btn btn-secondary btn-small" onclick="closePeriod()">
                        üîí –ó–∞–∫—Ä—ã—Ç—å –º–µ—Å—è—Ü
                    </button>
                    <button class="btn btn-success btn-small" onclick="exportToExcel()">
                        üì• –≠–∫—Å–ø–æ—Ä—Ç –≤ Excel
                    </button>
                </div>
            </div>
        </div>

        <!-- –ë–ª–æ–∫ 2: –¢–∞–±–ª–∏—Ü–∞ -->
        <div class="block">
            <h2 class="block-title">üìã –¢–∞–±–ª–∏—Ü–∞ –∑–∞–ø–∏—Å–µ–π<span class="period-status open" id="period-status">–ü–µ—Ä–∏–æ–¥ –æ—Ç–∫—Ä—ã—Ç</span></h2>
            
            <div class="filters">
                <div class="form-group" style="margin-bottom: 0;">
                    <label>–§–∏–ª—å—Ç—Ä –ø–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫—É</label>
                    <select id="filter-employee" onchange="filterRecords()">
                        <option value="">–í—Å–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏</option>
                    </select>
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                    <label>–° –¥–∞—Ç—ã</label>
                    <input type="date" id="filter-date-from" onchange="filterRecords()">
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                    <label>–î–æ –¥–∞—Ç—ã</label>
                    <input type="date" id="filter-date-to" onchange="filterRecords()">
                </div>
            </div>

            <div class="table-container">
                <table id="records-table">
                    <thead>
                        <tr>
                            <th>–î–∞—Ç–∞</th>
                            <th>–°–æ—Ç—Ä—É–¥–Ω–∏–∫</th>
                            <th>–ß–∞—Å—ã</th>
                            <th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
                            <th>–¢–∏–ø –¥–Ω—è</th>
                            <th>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th>
                            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                    </thead>
                    <tbody id="records-body">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- –ë–ª–æ–∫ 4: –û–±—â–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ -->
        <div class="block">
            <h2 class="block-title">üìä –û–±—â–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –∫–æ–º–∞–Ω–¥—ã</h2>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="total-hours">0</div>
                    <div class="stat-label">–û–±—â–∏–µ —á–∞—Å—ã</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="avg-hours">0</div>
                    <div class="stat-label">–°—Ä–µ–¥–Ω–µ–µ –Ω–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞</div>
                </div>
                <div class="stat-card danger">
                    <div class="stat-value" id="most-loaded">‚Äî</div>
                    <div class="stat-label">–ü–µ—Ä–µ–≥—Ä—É–∂–µ–Ω</div>
                </div>
                <div class="stat-card success">
                    <div class="stat-value" id="least-loaded">‚Äî</div>
                    <div class="stat-label">–ù–µ–¥–æ–∑–∞–≥—Ä—É–∂–µ–Ω</div>
                </div>
                <div class="stat-card warning">
                    <div class="stat-value" id="meetings-percent">0%</div>
                    <div class="stat-label">–í—Ä–µ–º—è –Ω–∞ –≤—Å—Ç—Ä–µ—á–∏</div>
                </div>
            </div>

            <div class="chart-container">
                <canvas id="team-chart"></canvas>
            </div>
        </div>
    </div>

    <script>
        // –î–∞–Ω–Ω—ã–µ
        const employees = [
            '–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω',
            '–ü–µ—Ç—Ä–æ–≤–∞ –ú–∞—Ä–∏—è',
            '–°–∏–¥–æ—Ä–æ–≤ –ê–ª–µ–∫—Å–µ–π',
            '–ö–æ–∑–ª–æ–≤–∞ –ï–ª–µ–Ω–∞',
            '–ú–æ—Ä–æ–∑–æ–≤ –î–º–∏—Ç—Ä–∏–π',
            '–ù–æ–≤–∏–∫–æ–≤–∞ –ê–Ω–Ω–∞',
            '–°–æ–∫–æ–ª–æ–≤ –ü–∞–≤–µ–ª',
            '–í–∞—Å–∏–ª—å–µ–≤–∞ –û–ª—å–≥–∞',
            '–§–µ–¥–æ—Ä–æ–≤ –°–µ—Ä–≥–µ–π',
            '–ú–∏—Ö–∞–π–ª–æ–≤–∞ –¢–∞—Ç—å—è–Ω–∞'
        ];

        const categories = {
            'operational': { name: '–û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–∞—è —Ä–∞–±–æ—Ç–∞', color: '#667eea' },
            'development': { name: '–†–∞–∑–≤–∏—Ç–∏–µ', color: '#10b981' },
            'meetings': { name: '–í—Å—Ç—Ä–µ—á–∏', color: '#f59e0b' },
            'planning': { name: '–ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ', color: '#8b5cf6' },
            'urgent': { name: '–°—Ä–æ—á–Ω—ã–µ –∑–∞–¥–∞—á–∏', color: '#ef4444' },
            'learning': { name: '–û–±—É—á–µ–Ω–∏–µ', color: '#06b6d4' }
        };

        let records = JSON.parse(localStorage.getItem('timeRecords') || '[]');
        let closedPeriods = JSON.parse(localStorage.getItem('closedPeriods') || '[]');
        let categoriesChart = null;
        let teamChart = null;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.addEventListener('DOMContentLoaded', function() {
            // –ó–∞–ø–æ–ª–Ω–∏—Ç—å dropdown —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
            const employeeSelects = ['employee', 'calc-employee', 'filter-employee'];
            employeeSelects.forEach(selectId => {
                const select = document.getElementById(selectId);
                employees.forEach(emp => {
                    const option = document.createElement('option');
                    option.value = emp;
                    option.textContent = emp;
                    select.appendChild(option);
                });
            });

            // –ó–∞–ø–æ–ª–Ω–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
            const categorySelect = document.getElementById('category');
            Object.entries(categories).forEach(([key, cat]) => {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = cat.name;
                categorySelect.appendChild(option);
            });

            // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–µ–∫—É—â—É—é –¥–∞—Ç—É
            document.getElementById('date').valueAsDate = new Date();
            
            // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü
            const now = new Date();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const year = now.getFullYear();
            document.getElementById('calc-period').value = `${year}-${month}`;

            // –û—Ç–æ–±—Ä–∞–∑–∏—Ç—å –∑–∞–ø–∏—Å–∏
            displayRecords();
            updateCalculations();
            updateTeamAnalytics();

            // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã
            document.getElementById('entry-form').addEventListener('submit', handleSubmit);
        });

        function handleSubmit(e) {
            e.preventDefault();

            const employee = document.getElementById('employee').value;
            const date = document.getElementById('date').value;
            const hours = parseFloat(document.getElementById('hours').value);
            const category = document.getElementById('category').value;
            const workType = document.getElementById('work-type').value;
            const comment = document.getElementById('comment').value;

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∑–∞–∫—Ä—ã—Ç—ã–π –ø–µ—Ä–∏–æ–¥
            const recordMonth = date.substring(0, 7);
            if (closedPeriods.includes(recordMonth)) {
                alert('‚ö†Ô∏è –ü–µ—Ä–∏–æ–¥ –∑–∞–∫—Ä—ã—Ç! –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–µ—â–µ–Ω–æ.');
                return;
            }

            const record = {
                id: Date.now(),
                employee,
                date,
                hours,
                category,
                workType,
                comment,
                createdAt: new Date().toISOString()
            };

            records.push(record);
            localStorage.setItem('timeRecords', JSON.stringify(records));

            // –ü–æ–∫–∞–∑–∞—Ç—å —É—Å–ø–µ—à–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
            const successMsg = document.getElementById('success-message');
            successMsg.textContent = `‚úÖ –ó–∞–ø–∏—Å—å –¥–ª—è ${employee} —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∞!`;
            successMsg.classList.add('show');
            setTimeout(() => successMsg.classList.remove('show'), 3000);

            // –û—á–∏—Å—Ç–∏—Ç—å —Ñ–æ—Ä–º—É
            e.target.reset();
            document.getElementById('date').valueAsDate = new Date();

            // –û–±–Ω–æ–≤–∏—Ç—å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            displayRecords();
            updateCalculations();
            updateTeamAnalytics();
        }

        function displayRecords() {
            const tbody = document.getElementById('records-body');
            
            if (records.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="empty-state">
                            <p>üì≠ –ù–µ—Ç –∑–∞–ø–∏—Å–µ–π</p>
                            <p style="font-size: 0.9rem; margin-top: 0.5rem;">–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—É—é –∑–∞–ø–∏—Å—å</p>
                        </td>
                    </tr>
                `;
                return;
            }

            // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –¥–∞—Ç–µ (–Ω–æ–≤—ã–µ –ø–µ—Ä–≤—ã–º–∏)
            const sorted = [...records].sort((a, b) => new Date(b.date) - new Date(a.date));

            tbody.innerHTML = sorted.map(record => {
                const workTypeLabels = {
                    office: 'üè¢ –û—Ñ–∏—Å',
                    remote: 'üè† –£–¥–∞–ª—ë–Ω–∫–∞',
                    hybrid: 'üîÄ –ì–∏–±—Ä–∏–¥'
                };

                const workTypeClass = `badge-${record.workType}`;
                const isPeriodClosed = closedPeriods.includes(record.date.substring(0, 7));

                return `
                    <tr>
                        <td>${new Date(record.date).toLocaleDateString('ru-RU')}</td>
                        <td><strong>${record.employee}</strong></td>
                        <td><strong>${record.hours}—á</strong></td>
                        <td>${categories[record.category].name}</td>
                        <td><span class="badge ${workTypeClass}">${workTypeLabels[record.workType]}</span></td>
                        <td>${record.comment || '‚Äî'}</td>
                        <td>
                            ${!isPeriodClosed ? `<button class="delete-btn" onclick="deleteRecord(${record.id})">–£–¥–∞–ª–∏—Ç—å</button>` : 'üîí'}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function filterRecords() {
            const filterEmployee = document.getElementById('filter-employee').value;
            const filterDateFrom = document.getElementById('filter-date-from').value;
            const filterDateTo = document.getElementById('filter-date-to').value;

            let filtered = records;

            if (filterEmployee) {
                filtered = filtered.filter(r => r.employee === filterEmployee);
            }

            if (filterDateFrom) {
                filtered = filtered.filter(r => r.date >= filterDateFrom);
            }

            if (filterDateTo) {
                filtered = filtered.filter(r => r.date <= filterDateTo);
            }

            const tbody = document.getElementById('records-body');
            const sorted = [...filtered].sort((a, b) => new Date(b.date) - new Date(a.date));

            if (sorted.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="empty-state">
                            <p>üîç –ù–µ—Ç –∑–∞–ø–∏—Å–µ–π –ø–æ —Ñ–∏–ª—å—Ç—Ä–∞–º</p>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = sorted.map(record => {
                const workTypeLabels = {
                    office: 'üè¢ –û—Ñ–∏—Å',
                    remote: 'üè† –£–¥–∞–ª—ë–Ω–∫–∞',
                    hybrid: 'üîÄ –ì–∏–±—Ä–∏–¥'
                };

                const workTypeClass = `badge-${record.workType}`;
                const isPeriodClosed = closedPeriods.includes(record.date.substring(0, 7));

                return `
                    <tr>
                        <td>${new Date(record.date).toLocaleDateString('ru-RU')}</td>
                        <td><strong>${record.employee}</strong></td>
                        <td><strong>${record.hours}—á</strong></td>
                        <td>${categories[record.category].name}</td>
                        <td><span class="badge ${workTypeClass}">${workTypeLabels[record.workType]}</span></td>
                        <td>${record.comment || '‚Äî'}</td>
                        <td>
                            ${!isPeriodClosed ? `<button class="delete-btn" onclick="deleteRecord(${record.id})">–£–¥–∞–ª–∏—Ç—å</button>` : 'üîí'}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function deleteRecord(id) {
            if (confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å?')) {
                records = records.filter(r => r.id !== id);
                localStorage.setItem('timeRecords', JSON.stringify(records));
                displayRecords();
                filterRecords();
                updateCalculations();
                updateTeamAnalytics();
            }
        }

        function updateCalculations() {
            const employee = document.getElementById('calc-employee').value;
            const period = document.getElementById('calc-period').value;

            if (!employee || !period) {
                return;
            }

            // –§–∏–ª—å—Ç—Ä –∑–∞–ø–∏—Å–µ–π –ø–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫—É –∏ –ø–µ—Ä–∏–æ–¥—É
            const filtered = records.filter(r => {
                return r.employee === employee && r.date.startsWith(period);
            });

            // –†–∞—Å—á—ë—Ç —á–∞—Å–æ–≤
            const norm = 168; // –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–º
            const fact = filtered.reduce((sum, r) => sum + r.hours, 0);
            const deviation = fact - norm;
            const overtime = deviation > 0 ? deviation : 0;
            const overtimePercent = (overtime / norm) * 100;

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
            document.getElementById('norm-hours').textContent = norm;
            document.getElementById('fact-hours').textContent = fact.toFixed(1);
            document.getElementById('deviation').textContent = deviation > 0 ? `+${deviation.toFixed(1)}` : deviation.toFixed(1);
            document.getElementById('overtime').textContent = overtime.toFixed(1);

            // –¶–≤–µ—Ç –∫–∞—Ä—Ç–æ—á–∫–∏ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è
            const deviationCard = document.getElementById('deviation-card');
            if (deviation > 0) {
                deviationCard.className = 'stat-card warning';
            } else if (deviation < -20) {
                deviationCard.className = 'stat-card danger';
            } else {
                deviationCard.className = 'stat-card';
            }

            // –¶–≤–µ—Ç –∫–∞—Ä—Ç–æ—á–∫–∏ –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∏
            const overtimeCard = document.getElementById('overtime-card');
            if (overtimePercent > 10) {
                overtimeCard.className = 'stat-card danger';
            } else {
                overtimeCard.className = 'stat-card warning';
            }

            // –†–∞—Å—á—ë—Ç –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
            const categoryHours = {};
            Object.keys(categories).forEach(key => {
                categoryHours[key] = 0;
            });

            filtered.forEach(r => {
                categoryHours[r.category] += r.hours;
            });

            // –ì—Ä–∞—Ñ–∏–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
            updateCategoriesChart(categoryHours, fact);
        }

        function updateCategoriesChart(categoryHours, totalHours) {
            const ctx = document.getElementById('categories-chart');
            
            if (categoriesChart) {
                categoriesChart.destroy();
            }

            const data = Object.entries(categoryHours).filter(([k, v]) => v > 0);
            
            if (data.length === 0) {
                ctx.getContext('2d').clearRect(0, 0, ctx.width, ctx.height);
                return;
            }

            categoriesChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: data.map(([k, v]) => `${categories[k].name} (${((v/totalHours)*100).toFixed(1)}%)`),
                    datasets: [{
                        data: data.map(([k, v]) => v),
                        backgroundColor: data.map(([k, v]) => categories[k].color),
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        title: {
                            display: true,
                            text: '–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º'
                        }
                    }
                }
            });
        }

        function updateTeamAnalytics() {
            // –û–±—â–∏–µ —á–∞—Å—ã
            const totalHours = records.reduce((sum, r) => sum + r.hours, 0);
            document.getElementById('total-hours').textContent = totalHours.toFixed(1);

            // –°—Ä–µ–¥–Ω–µ–µ –Ω–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
            const avgHours = employees.length > 0 ? totalHours / employees.length : 0;
            document.getElementById('avg-hours').textContent = avgHours.toFixed(1);

            // –ß–∞—Å—ã –ø–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º
            const employeeHours = {};
            employees.forEach(emp => {
                employeeHours[emp] = records.filter(r => r.employee === emp)
                    .reduce((sum, r) => sum + r.hours, 0);
            });

            // –°–∞–º—ã–π –ø–µ—Ä–µ–≥—Ä—É–∂–µ–Ω–Ω—ã–π
            const maxEmployee = Object.entries(employeeHours)
                .sort((a, b) => b[1] - a[1])[0];
            document.getElementById('most-loaded').textContent = maxEmployee 
                ? `${maxEmployee[0].split(' ')[0]} (${maxEmployee[1].toFixed(1)}—á)` 
                : '‚Äî';

            // –°–∞–º—ã–π –Ω–µ–¥–æ–∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–π
            const minEmployee = Object.entries(employeeHours)
                .filter(([k, v]) => v > 0)
                .sort((a, b) => a[1] - b[1])[0];
            document.getElementById('least-loaded').textContent = minEmployee 
                ? `${minEmployee[0].split(' ')[0]} (${minEmployee[1].toFixed(1)}—á)` 
                : '‚Äî';

            // % –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞ –≤—Å—Ç—Ä–µ—á–∏
            const meetingHours = records.filter(r => r.category === 'meetings')
                .reduce((sum, r) => sum + r.hours, 0);
            const meetingPercent = totalHours > 0 ? (meetingHours / totalHours) * 100 : 0;
            document.getElementById('meetings-percent').textContent = meetingPercent.toFixed(1) + '%';

            // –ì—Ä–∞—Ñ–∏–∫ –∫–æ–º–∞–Ω–¥—ã
            updateTeamChart(employeeHours);
        }

        function updateTeamChart(employeeHours) {
            const ctx = document.getElementById('team-chart');
            
            if (teamChart) {
                teamChart.destroy();
            }

            const data = Object.entries(employeeHours)
                .filter(([k, v]) => v > 0)
                .sort((a, b) => b[1] - a[1]);

            if (data.length === 0) {
                return;
            }

            teamChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(([k, v]) => k.split(' ')[0]),
                    datasets: [{
                        label: '–ß–∞—Å—ã',
                        data: data.map(([k, v]) => v),
                        backgroundColor: '#667eea',
                        borderColor: '#764ba2',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        title: {
                            display: true,
                            text: '–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —á–∞—Å–æ–≤ –ø–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function closePeriod() {
            const period = document.getElementById('calc-period').value;
            
            if (!period) {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–∏–æ–¥ –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è');
                return;
            }

            if (closedPeriods.includes(period)) {
                alert('‚ö†Ô∏è –ü–µ—Ä–∏–æ–¥ —É–∂–µ –∑–∞–∫—Ä—ã—Ç');
                return;
            }

            if (confirm(`–ó–∞–∫—Ä—ã—Ç—å –ø–µ—Ä–∏–æ–¥ ${period}? –ü–æ—Å–ª–µ –∑–∞–∫—Ä—ã—Ç–∏—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –±—É–¥–µ—Ç –∑–∞–ø—Ä–µ—â–µ–Ω–æ.`)) {
                closedPeriods.push(period);
                localStorage.setItem('closedPeriods', JSON.stringify(closedPeriods));
                
                const statusEl = document.getElementById('period-status');
                statusEl.textContent = '–ü–µ—Ä–∏–æ–¥ –∑–∞–∫—Ä—ã—Ç';
                statusEl.className = 'period-status closed';
                
                displayRecords();
                alert('‚úÖ –ü–µ—Ä–∏–æ–¥ —É—Å–ø–µ—à–Ω–æ –∑–∞–∫—Ä—ã—Ç');
            }
        }

        function exportToExcel() {
            if (records.length === 0) {
                alert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞');
                return;
            }

            // –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö
            const data = records.map(r => ({
                '–î–∞—Ç–∞': new Date(r.date).toLocaleDateString('ru-RU'),
                '–°–æ—Ç—Ä—É–¥–Ω–∏–∫': r.employee,
                '–ß–∞—Å—ã': r.hours,
                '–ö–∞—Ç–µ–≥–æ—Ä–∏—è': categories[r.category].name,
                '–¢–∏–ø –¥–Ω—è': r.workType === 'office' ? '–û—Ñ–∏—Å' : r.workType === 'remote' ? '–£–¥–∞–ª—ë–Ω–∫–∞' : '–ì–∏–±—Ä–∏–¥',
                '–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π': r.comment || ''
            }));

            // –°–æ–∑–¥–∞–Ω–∏–µ Excel
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, '–£—á—ë—Ç –≤—Ä–µ–º–µ–Ω–∏');

            // –°–∫–∞—á–∏–≤–∞–Ω–∏–µ
            const fileName = `timetracking_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, fileName);
        }
    </script>
</body>
</html>